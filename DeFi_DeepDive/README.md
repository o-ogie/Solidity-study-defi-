# DeFi

디파이란 탈중앙화 금융의 약자로서, 블록체인을 기반으로 한 탈중앙화된 분산금융을 의미한다.
주로 암호화폐를 담보로 걸고 일정 금액을 대출 받거나, 혹은 다른 담보를 제공하고 암호화폐를 대출받는 방식으로 작동한다.
그 외에 암호화폐끼리의 교환, 유동성 공급 및 스텓이킹을 통한 이자농사가 있다.

블록체인의 기술 상위에 구현된 Dapp으로서, 스마트 컨트랙트라는 매개체를 통해 중개자(은행, 거래소 등의 주체)의 동무 없이도
개인 대 개인의 금융 활동이 가능해졌다.

DeFi는 기존 자리를 잡고 있는 은행들처럼 같은 길을 걷고 있는 실상이고
초기 웹페이지 처럼, sql인젝션 등 많은 보안적인 위험이나, 취약점이 많았지만 점차 나아갔다.
DeFi도 현제 기술적으로 얼마 안되었고, 기술자들이라고 하더라도 0세대~ 1세대들은 5~6년차 정도이기 때문에 점차
성장할 것이다.

스마트 컨트랙트를 개발하면 보안을 감사해주는 업체들이 생겨나고 있고, contract odc라는 이름으로 컨트랙트를 감사해주는 있다. 


## 메타마스크
이더리움 등 암호화폐(가상자산)을 보관, 송금, 관리 할 수 있는 지갑 소프트웨어,

## 지갑? Wallet?
말 그대로 지갑의 역할을 한다.
일반적으로 금전을 보관하는 것이 아닌 암호화폐(가상자산)을 보관하거나, 고유권을 양도하는 역할을 하는 소프트웨어의 한 종류

직바은 자산을 관리하는 도구로써 분만 아니라,
탈 중앙화(Dex, Lending DeFi) 애플리케이션들(DApps)과 상호 작용하기 위해 사용하기도 한다.
가스비를 내야할 때 지갑이 연동되어 있다면 알아서 지갑의 자산이 빠져나간다.
ex) metamask, coinbase

### Wallets 종류
 - 핫 월렛
 모바일 기기, 데스크탑 및 인터넷이 브라우저에 연결되어 있는 지갑
 > 메타마스크, 카이카스(Kaikas), 클립( Klip )
 들고 다닐 필요가 없음.
 사용이 비교적 간편하다.
 보안에 취약하다.


 - 콜드 월렛
 하드웨어 지갑으로, 지갑을 사용할 때에만 인터넷에 연결되거나, QR코드를 활용하는 종이 지갑도 있다.
들고다니기 힘들다
사용이 비교적 어려울 수 있다.
보안에 강함.

### 개인키(Private Key)
지갑 로그인할때 사용함.
공인 인증서와 같다.
 12개의 단어로 이루어진 시드 구문이 있음.
 특정 지갑의 시드 구문만 알면 어디서든 그 지갑에 로그인이 가능하다.
 인터넷이 있는 어디에서나.


### 공개키 (Public Key)
지갑 주소와 연관이 있음. 지갑과 같다고 생각해도 된다.
공개키 주인이 누구인지는 모르지만 거래 내역들은 모두에게 공개됨.
거래소도 하나의 지갑이다.

 - ENS ( Ethereum Name Service )
    DNS처럼 이름에 공개키를 매핑시키는 것이다.

## DEX
탈주앙화 거래소
- 블로겣인을 활용한 탈중앙화로서 모든 거래는 스마트 컨트랙트에 의해. 즉, 코드로 실행이 되고,
모든 거래 내역은 블록체인 상에 투명하게 기록이 된다.
중앙화가 아니기에 통제가 크게 없이 자유롭고, 거래의 익명성 또한 보장된다.
DEX의 반대로는 업비트와 빗섬 같이 대중적으로 알고 있는 중앙화 거래소 CEX(Centralized Exchange)가 있다.

defillama.com에보면 디파이의 프로토콜들을 볼 수 있음.

모든 프로토콜의 중심이 된다.
Leding, Leverage, Aggregator, Bridge 등 대부분 DEX를 중심으로 파생된다.

CEX(중앙화 거래소)와비교
중앙화 거래소는 오더북?기반으로 거래가 이루어진다. (호가창이라고도 함)

탈중앙화 거래소 (DEX)
- DEX는 구매자와 판매자 간에 직접 거래되는 P2P거래소이다.
- 거래의 중개자는 스마트 컨트랙트이다.
- CEX의 오더북 기반이 아닌 AMM이라는 자동 알고리즘 트레이딩을 통해 거래와 가격이 이루어진다.
    - AMM 알고리즘 스마트 컨트랙트 상의 코드이다.
    - 모든 거래는 트랜잭션으로 이루어지고 거래가 일어나면 이더스캔과 같은 익스플로러에서 확인이 가능하다.
    - 거래이지만 코드상으로 스왑이 이루어진다.
- DEX에서는 암호화폐로 암호화폐를 구매하는 Swap 방식으로 거래가 된다.

### AMM
UNISWAP
- DEX의 아버지, AMM의 시초.

SushiSwap, Curve 등 많은 거래소들이 유니스왑을 Fork, 커스터마이징을 통해 만들어짐.

SushiSwap
- UniSwap을 포크, sushi Token을 활용한 거버넌스 토크노믹스 수립
- 스시스왑의 거버넌스 토크노믹스도 다른 덱스들도 커스터마이징을 해서 사용하고잇음.
- 거버넌스 토큰을 발행하는 파일이름도 마스터쉡이라고 한다.

Curve
- 스테이블 코인 위주의 DEX인데
- Uniswap의 AMM을 맞춤 개선 Defillama기준 DEX TVL 1위

### DEX의 대표 기능
- 토큰들의 스왑
    - 스왑하기 위해서는 풀안에 어느정도 두 토큰들의 수량이 존재해야함.
- 유동성 공급
    - 풀에 자산을 제공해주는 것
    - 제공해주는 조건으로 이자를 얻는데 이를 이자농사라고함.
    - 유동성을 공급하면 이자를 주는데 그 이자를 가지고 이자농사가 또 가능하기도 함.
- 이자농사 ( 거버넌스 토큰 )
- DAO ( Decentralized Autonomous Organization ) 탈중앙화 자율 조직
- 거버넌스 토큰의 활용( 토크노믹스 )

DEX Reference
https://traderjoexyz.com/home#/
https://pancakeswap.finance/

Q. 모든 거래소의 가격이 똑같을까? 어떻게 맞춰질까?
A. 완벽히 똑같지 않지만 어느정도 맞춰져 있다.
 => 아비트라지(arbitrage) 차익거래 때문이다. DEX, CEX 구분없이 똑같음.

수백개 수천개 아비트라지 봇은 갈수록 고도화 되고 있다.
거래소끼리의 이동 시 수수료 (업비트; 이더리움 송금시 0.01ETH)
최적의(최단거리) 알고리즘 ( e.g Bellman-Ford algorithm )
암호화폐 이동 중에 가격이 바뀌면 ? => 손해
DEX의 경우 Swap까지 해가며 기회를 엿본다.

-------------------------------------

# 유동성 공급
- 유동성 공급(Liquidity Provide)은 탈중앙화 거래소에서 토큰끼리 Swap을 할 때,
유저들에게 자신의 토큰을 제공하고, 거기서 발생되는 수수료를 얻는 행위를 말한다.

유동성 공급을 하면 토큰을 제공하게 되는 행위에 보상으로 이자를 받는다.
이자는 스왑하면서 발생하는 수수료의 일부분을 받는 것.

토큰들이 모인 곳을 유동성 풀(LP)라고 하는데 여기에 토큰 자산들을 제공하는 것이 유동성 공급이다.
이 풀에서 스왑이 일어나면 수수료가 발생하는데 이 수수료의 일부를 제공자는 받을 수 있다.

ex) trader들은 0.25%의 수수료를 내고 제공자들은 0.17%를 받아간다.

유동성 공급을 할때는 토큰의 가치가 1:1이 되도록 공급을 해야한다. BTC가치가 15이고 ETH가치가 1일때,
1BTC : 15ETH


## LP 토큰
- 유동성 공급자가 유동성 풀에 유동성 공급을하고 그에 가지에 해당하는 증표를 받는다.
LP토큰은 유동성을 공급했던 증표이면서, LP토큰을 다시 공급했던 유동성 토큰들로 교환할 수 있다.

### LP 토큰의 활용
LP토큰을 다시 예치함으로 프로토콜에서 자기들의 토큰을 나누어 주기도 한다. (cake, sushi,...)
( 유동성 공급자가 최대한 유동성 공급을 오래 유지하도록 하기 위해 /TVL과 직접적 관계가 있음.)
ex) https://traderjoexyz.com/farm


## TVL ?
TVL ( TOtal value Locked)은 해당 프로토콜에 얼마나 많은 자산들이 담겨 있는지에 대한 수치이다.
DEX의 유동성 뿐만아니라 Lending Protocol의 담보자산들 등이 해당한다.

TVL이 높다는 것은
인가가 많은 프로토콜이다. 유저들의 신뢰를 얻을 가능성이 높다.
풀에 많은 토큰들이 담겨있다는 것이다.

유동성 풀에 토큰이 많이 담겨잇다면 뭐가 좋을까 ?
- 슬리피지, 프라이스 임팩트로 예시를 들 수 있다.


------------------
# AMM 이란?
- AMM ( Automated Market Maker )은 암호화폐를 구매, 판매하고자 할 때, 
스왑 수학 공식을 통해 자산의 가격을 결정시키는 자동 알고리즘 트레이딩(AAT)이다.

기존 중앙화 거래소는 토큰을 사고파고 할때 오더북 방식으로 진행됨. ( 호가창 )
원하는 가격대에 자산을 올려두고 원하는 사람이 구매하는 방식. 흔히 주식이나 코인거래가 여기에 해당한다. ex) 업비트, 빗썸... 

탈중앙화 거래소에서는 AMM방식으로 자산을 사고 팔 수 있다.
AMM은 커스터마이징이 된 종류가 많지만 대표적으로
CP-AMM(ConstantProduct -AMM)
유니스왑에서온 기본적인 AMM이고, 현재까지 많은 덱스들이 사용하고잇다.

CS-AMM(Constant Sum)
비교적 간단하지만 스테이블 전용 덱스인 커버가 이를 커스터마이징함.

## CP-AMM
X * Y = K라는 공식으로 진행이된다.
X와 Y를 곱하였을 때, 값이 항상 K이어야 한다.

비트코인 1000만원 이더리움 100만원을 가정할 때

두개 토큰으로 유동성 공급을 하려면 1:1비율로 공급해야한다.
BTC:ETH = 1: 10

CPAMM 관점으로 보면 비트코인 10개 이더리움 100개를 공급했다고 하자.
X는 비트코인, Y는 이더리움
10 * 100 = 1000
K는 1000으로 고정이 된다.

1BTC로 몇개의 ETH를 가져갈 수 있을까?
여기서 AMM으로 해결한다.
(10 + 1) * ??(ETH) = 1000
??(ETH) = 1000/11
        = 90.909090...
    
식을 다시 세워보면
11 * 90.909090... = 1000이 되는 것이다. 

BTC는 물량이 늘고, ETH는 줄고
BTC는 보다 흔해지고, ETH는 귀해지고
BTC의 가격은 떨어직고, ETH는 올랐따.
이게 AMM의 가격조정 원리이다. 가격이 결정되는 과정


5BTC를 유동성 풀에 넣는다면?
45.4545..개를 받는게 아니라
33.33개를 받는다.
이러한 현상을 `프라이스 임팩트(Price Impact)`라고 한다.
( 특정 풀에 유동서이 적어 토큰을 교환할 대 교환 비율(가격)이 크게 바뀌는 것. )


슬리피지( Slippage )
특정 풀에 유동성이 적어 토큰을 교환하는 순간
토큰의 교환비(X * Y =K)가 변화하여 예상했떤 수량보다 적게 받는 상황 

## CS-AMM
X + Y = K로 정의한다.

프라이스 임팩트, 슬리피지가 발생하지 않는다.
거래할 시 항상 같은 비율의 자산을 가져갈 수 있다.
한 쪽 자산이 0이 되면 더 이상 거래를 할 수 없다.


## Curve case - Stable Swap
CP-AMM + CS-AMM

## Hybrid CFMMs
- curve는 스테이블 코인의 스왑을 전문으로 하는 덱스이다
- 스테이블 코인은 변동성이 적고, 모든 스테이블 코인은 가격이 거의 동일하기 때문에 csAMM과 잘 어울린다.
- 완전한 CS-AMM은 한쪽 자산이 0이 될 수 있기 때무넹, 일정 유ㅜ동성 범위를 넘어가면 CPAMM과 같이 처리한다.



--------------------------------

# 비 영구적 손실 ( IL, Impermanent Loss)
유동성 공급은 자산을 맡김으로 이자를 받는데 손실이 어떻게 일어날까?

ex)
ETH - 1000  USDT - 1
ETH - 20개  USDT - 20000개
20000       20000

바이낸스와 유니스왑에서는 이더리움이 1000이었다.
바이낸스에서 이더리움이 1500까지 급등을 했다면?
아비트라지 봇들이 감지하고 유니스왑에서 스왑하고 바이낸스에서 파는 행위를 계속 할 것이다.

봇은 USDT를 넣고 ETH를 빼와서 바이낸스에서 파는 것이다.
그렇다면 풀에서는 USDT는 늘어나고 ETH는 줄어든다. ( ETH가1500의 가치가 맞춰질 때 까지 )

ETH = 16.33개   USDT = 24,495개가 된다.



만약 가만히 거래소에 들고 있었다면?

ETH 20 * 1500 = 30000
USDT 20000 * 1 = 20000
=> 50000

ETH 16.33 * 1500 = 24,494
USDT = 24495 * 1 = 24,494

 48989.79
손실이 발생함


비열구적 손실은 왜 발생할까
AMM으로 인한 토큰의 수량이 변화하기 때문이다.


비영구적 손실을 최소화 하는 법은?
거래량이 높은 유동성 풀을 선태갛여 유동성을 공급한다. ( 수수료 극대화 )
LP 토큰을 다시 예치하여 부가 수익을 노린다.
APR(Annual Percentage Rate)이 노픈 풀을 선택한다.
스테이블 코인을 활용한다. 


--------------------------------
# 거버넌스 토큰
거버넌스 - 일반적으로 과거의 일방적인 정부 주도적 경향에서 벗어나 정부, 기업, 비정부기구 등 다양한 행위자가 공동의 관심사에 대한 네트워크를 구축하여
문제를 해결하는 새로운 국정 운영 방식.

거버넌스 토큰 - 특정 프로토콜이 발행한 토큰으로 일종의 주식개념이다. 거버넌스 토큰을 소유한 사용자는 특정 프로토콜의 지분을 가지고 있는 것과 같으며, 사용처는 다양함.

거버넌스 토큰 등장
20년 4월 컴파운드는 DAO로 전환하면서 프로토콜 사용자들에게 자신들의 토큰인 COMP토큰(거버넌스 토큰) 에어드랍을 선언하고, 20년 6월 에어드랍을 완료했다.
이후 디파이 시장은 썸머를 맞이하고, 디파이의 이자 농사 개념을 수립함.

유니스왑을 포크한 스시스왑은 기존 유니스오바의 토크노믹스에서 자신들의 거버넌스 토큰인 스시를 발행하여 활용한 새로은 토크노믹스를 수립함.

pancakeSwap - cake
traderjoe - joe
klaySwap - ksp
등등이 거버넌스 토큰이다.


## 활용처
- 거버넌스 토큰을 얻어 시장에 판매하여 수익을 얻는다.
- 거버넌스 토큰을 예치하여 이자 수익을 받는다
- 거버넌스를 활용한 프로토콜의 추가 기능들을 이요한다( 토크노믹스 )
- 프로토콜의 의제 투표에 참여한다 (DAO)

**어떠게 얻는지?**
각 프로토콜마다의 토크노믹스를 통하여 거버넌스 토큰을 얻을 수 있다. (에어드랍, 스테이킹 등)
DEX의 경우 유동성 공급 후 받는 LP 토큰을 또 한번 예치를 하여 거버넌스 토큰을 얻는 방법이 대중적이다.


프로토콜 입장에서의 거버넌스 토큰
- 거버넌스 토큰은 곧, 특정 프로토콜의 주 매출원 ( 주식 발행 개념 )
- 거버넌스 토큰을 활용한 토크놈기스는 프로토콜의 매력도 높임(TVL)
- 가격 부양에 신경을 쓰지 않으면 프로토콜은 점점 몰락
- 가격 부양을 위해 거버넌스 토큰의 활용처를 꾸준히 물색 필요 ( 보유자의 판매를 막기 위해)

유동성을 최대한 묶어두는 역할
유동성이 많이 있으면 TVL이 높고 사용자들에게 매력적으로 다가갈 수 있음.
가격이 높을 수록 프로토콜의 자산이 늘어남
거버넌스의 다양한 활용처가 중요한 이유는 
거버넌스 토큰을 받자마자 팔기만하면 거버넌스 토큰은 한없이 가치가 떨어지기만 한다.
따라서 팔지앖고 활용할 수 있는 다양한 활용처를 물색하여 팔지 않도록 한다.

--------------------------
# 렌딩 프로토콜 ( Lending Protocol )
예금, 대출을 위한 서비스이다. 시중 은행과 같은 역할을 하는 디파이 프로토콜이다.
디파이에서의 예금, 대출은 토큰의 예금, 대출을 얘기한다.


## 은행 원리 - 예금
- 고객은 은행에 예금을 할 수 있다.
- 은행은 예금 이자를 준다.

음행의 예금이자는 어디서 오는 돈인가? 
-> 고객의 대출이자.


## 은행 원리 - 대출
- 고객은 은행에서 대출을 할 수 있다.
- 대출 원금과 이자를 함께 갚는다.

신용 대출, 담보 대출 등이 있다.

**랜딩 프로토콜을 이용하는 이유?**
- 장기 투자자로서 팔 생각이 없는데 돈이 필요할 때
- 대출을 받아 운용을 하여 축다 수익을 노릴 때 ( 유동성 공급, 이자 농사 )
- 방향성 매매( + 레버리지 )
기본적으로 추가 수익을 노리기 위해서이다.

## 방향성 매매
- 가격 상승에 배팅
    가격이 상승할 것으로 예상되는 자산을 맡기고 대출 후, 추가 구매

- 가격 하락에 배팅
    가격이 하락할 것으로 예상되는 자산을 빌리고 판매 후, 가격 하락 후에 추가 구매
    공매도같은 개념. 비쌀때 빌려서 팔고 쌀때 사서 빌린 것을 갚음.

## 방향성 매매 - 레버리지
- 가격 상승에 배팅
가격이 상승할 것으로 예상되는 자산을 맡기고 대출 후, 추가 구매
... 후에 자산을 또 맡기고 대출 후 구매 ... 후에 자산을 또 맡기고 대출 후 구매

청산
- 담보로 맡긴 자산의 가치가 하라갛여, 대출로 빌려간 자산의 가치보다 가치가 낮아질 위험이 있을 때(낮아졌을 때 ),
프로토콜은 사용자의 담보를 판매하여 원금을 회수한다. 담보 받는 토큰마다 LTV(Loan To Value)은 다를 수 있다..

